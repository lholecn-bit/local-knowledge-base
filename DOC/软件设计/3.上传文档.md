# 3. 上传文档

本文件详细说明“上传文档”功能的调用链，具体到每个环节涉及的文件与函数，并用 Mermaid 时序图展示全流程。

## 概要

- 功能：用户在前端选择文件上传，后端将文档分块、向量化、存储并更新元数据。
- 关键环节：前端表单提交、API 封装、Flask 路由、知识库管理、分块与向量化、元数据写入。

## 详细时序图（Mermaid）

```mermaid
sequenceDiagram
    participant User as 用户
    participant App as App (`frontend/js/app.js` → `handleFileUpload()`)
    participant API as API (`frontend/js/api.js` → `uploadFiles()`)
    participant Flask as Flask (`backend/app.py` → `upload_documents()`)
    participant KB as LocalKnowledgeBase (`backend/knowledge_base.py` → `add_documents_from_upload()`)
    participant KB2 as LocalKnowledgeBase (`backend/knowledge_base.py` → `add_documents()`)
    participant Split as TextSplitter (`langchain_community`)
    participant Embed as Embeddings (`backend/embeddings.py`)
    participant FAISS as FAISS Index (knowledge_db/faiss_index/index.faiss)
    participant Metadata as metadata (knowledge_db/metadata.json)

    User->>App: 选择文件并点击上传
    App->>API: `handleFileUpload()` → `uploadFiles(files)`
    API->>Flask: POST /api/documents/upload (FormData)
    Flask->>KB: `upload_documents()` → `kb.add_documents_from_upload(files)`
    KB->>KB2: `add_documents_from_upload()` → `add_documents(file_paths)`
    KB2->>Split: 文本分块（RecursiveCharacterTextSplitter）
    Split-->>KB2: 返回文本块列表
    KB2->>Embed: 文本块向量化（OpenAIEmbeddings）
    Embed-->>KB2: 返回向量
    KB2->>FAISS: 存储向量到索引
    KB2->>Metadata: 更新 metadata.json（文件名、hash、时间、块数）
    Metadata-->>KB2: 写入完成
    KB2-->>KB: 返回上传结果（added_chunks, files, errors）
    KB-->>Flask: 返回上传结果
    Flask-->>API: 返回 JSON 响应
    API-->>App: 返回上传结果
    App->>User: 显示上传成功/失败及新增块数
```

## 具体文件与函数对照

- `frontend/js/app.js`：`handleFileUpload(files)` — 处理文件选择与上传逻辑。
- `frontend/js/api.js`：`uploadFiles(files)` — 发送 POST /api/documents/upload（FormData）。
- `backend/app.py`：`upload_documents()` — Flask 路由，接收上传请求，调用知识库方法。
- `backend/knowledge_base.py`：`add_documents_from_upload(files)` — 处理上传的 FileStorage 列表，保存临时文件。
- `backend/knowledge_base.py`：`add_documents(file_paths)` — 文本分块、向量化、存储、元数据更新。
- `langchain_community.text_splitters`：`RecursiveCharacterTextSplitter` — 文本分块。
- `backend/embeddings.py` 或 `langchain_openai`：`OpenAIEmbeddings` — 文本块向量化。
- `knowledge_db/faiss_index/index.faiss`：FAISS 索引文件，存储向量。
- `knowledge_db/metadata.json`：存储文件元数据与分块信息。

## 关键代码片段（便于快速定位）

- 路由入口：`backend/app.py` 的 `upload_documents()`
- 上传处理：`backend/knowledge_base.py` 的 `add_documents_from_upload()`、`add_documents()`
- 前端触发：`frontend/js/app.js` 的 `handleFileUpload()`、`frontend/js/api.js` 的 `uploadFiles()`

## 扩展建议

- 支持多文件批量上传，前端已用 FormData 多文件字段。
- 可在后端增加文件类型/大小校验，或上传进度回调。

---

作者：自动生成
日期：2025-12-24
